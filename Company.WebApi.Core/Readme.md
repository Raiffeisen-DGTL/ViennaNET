# Основная сборка для поднятия сервисов. Содержит билдер WebApi-сервисов. Использует только стандартные средства AspNetCore + Swagger

### Инструкция по применению

Основной класс - HostBuilder. Разбит на 3 файла:
*  HostBuilder.cs - содержит поля, хранящие настройки и собственно сам метод Build
*  HostBuilderActions.cs - содержит методы для заполнения билдера
*  HostBuilderValidation.cs - содержит метод валидации состояния билдера

Неконфигурируемые настройки:
*  Подключение Swagger
*  JSON-конфигурация

#### Настройка и запуск минимального сервиса:
1.  Создаем консольное приложение на .Net Core или Framework.
2.  Добавляем файл конфигурации **appsettings.json**, как видно, он содержит лишь настройку включения Swagger:

		{
		  "webApiConfiguration": {
			"swaggerSubmit": true
		  }
		}

3.  В Program.cs создаем экземпляр HostBuilder через Create().
4.  Так как сервер изначально не указан, то нужно это обязательно сделать. Например для подключения Kestrel (дополнительно пакет скачивать не нужно, так как Microsoft, зачем-то включила его в базовый метапакет для AspNetCore) с базовыми настройками достаточно вызвать метод билдера **UseServer((b, c) => { b.UseKestrel(); })**.
5.  Вызываем BuildWebHost()
6.  Вызываем Run()

Вот и всё, мы получили минимальный сервис, который запускается и работает.

_________________


### Список методов конфигурирования сервиса

*  AddMvcBuilderConfiguration - Позволяет дополнительно сконфигурировать MVC Builder
*  ConfigureApp - Конфигурирование внутреннего билдера приложения, здесь добавляются Middleware, применяется Cors и т.п.
*  AddMiddleware - Регистрирует стандартное middleware, без привязки к стороннему контейнеру
*  CreateContainer - Функция для создания объекта DI-контейнера. Если не была вызвана, то используется встроенный контейнер
*  VerifyContainer - Функция для вызова валидации стороннего контейнера
*  ConfigureContainer(Func) - Кофигурирует сторонний контейнер для **замещения** встроенного. Такой подход используют, например в Autofac
*  ConfigureContainer(Action) - Кофигурирует сторонний контейнер **без** замещения встроенного. Такой подход используют, например в SimpleInjector
*  InitializeContainer - Инициализация стороннего контейнера
*  RegisterServices - Регистрация сервисов в стандартном DI
*  UseServer - Настройка сервера (Kestrel, HttpSys, ...)
*  AddOnStartAction - Добавляет операцию, вызываемую после старта сервиса
*  AddOnStopAction - Добавляет операцию, вызываемую после остановки сервиса
*  AddHealthChecks - Добавляет HealthCheck-и (https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks)

### Диагностика
Для проверки состояния сервиса есть три URL:
*  **/ping** - просто пингует сервис
*  **/diagnostic/diagnose** - запускает все зарегистрированные HealthCheck-и и возвращает результат проверок. Возможные ответы: 200 - если все успешно, 503 - если хотя бы одна проверка не прошла, при этом всегда возвращается json-объект с результатами. Требует авторизации
*  **/diagnostic/service-diagnose** - работает аналогично /diagnostic/diagnose, но не возвращает структуру с подробной информацией о системе, только код ответа. Не требует авторизации

### Мониторинг
Для получения статистики по запросам и ответам сервиса есть два URL:
*  **/metrics** - возвращяет JSON-объект со статистикой
*  **/metrics-text** - возвращяет строковый эквивалент статистики

Для включения мониторинга в конфиг необходимо добавить секцию в конфигурационный файл

		{
		  "metrics": {
			  "enabled": true,
        "reporter": "default"
		  }
		}

**enabled** - включает и отключает сбор (по умолчанию false)
**reporter** - необязательное поле, указывается формат ответа:

*  "default" - базовый формат (значение по умолчанию)
*  "prometheus" - формат для приложения Prometheus. Переопределяется только результат по URL "/metrics-text"
